<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HOT Tasking Manager AI Predictions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
      .maplibregl-popup-content {
        padding: 8px 12px;
        border-radius: 8px;
      }
      .spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen overflow-hidden">
    <div
      id="authModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">Authentication Required</h2>
        <p class="text-gray-600 mb-4">
          Please enter your fAIr access token to generate AI predictions.
        </p>
        <input
          type="password"
          id="tokenInput"
          placeholder="Access Token"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
        />
        <div class="flex justify-end space-x-2">
          <button
            onclick="closeAuthModal()"
            class="px-4 py-2 text-gray-600 hover:text-gray-800"
          >
            Cancel
          </button>
          <button
            onclick="authenticateUser()"
            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"
          >
            <span id="authButtonText">Authenticate</span>
            <div
              id="authSpinner"
              class="spinner hidden inline-block ml-2"
            ></div>
          </button>
        </div>
      </div>
    </div>

    <div
      id="predictionModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    >
      <div
        class="bg-white rounded-lg p-6 w-[500px] max-w-[90vw] max-h-[80vh] overflow-y-auto"
      >
        <h2 class="text-xl font-bold mb-4">Generate AI Predictions</h2>
        <form id="predictionForm" class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Description</label
            >
            <input
              type="text"
              id="predictionDescription"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Folder</label
            >
            <input
              type="text"
              id="predictionFolder"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Model</label
            >
            <select
              id="modelSelect"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            >
              <option
                value="https://api-prod.fair.hotosm.org/api/v1/workspace/download/ramp/baseline.tflite"
                selected
              >
                Ramp
              </option>
              <option
                value="https://api-prod.fair.hotosm.org/api/v1/workspace/download/yolo/yolov8s_v2-seg.onnx"
              >
                YOLOv8
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Confidence (%)</label
            >
            <input
              type="number"
              id="confidence"
              min="0"
              max="100"
              step="1"
              value="25"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Tolerance</label
            >
            <input
              type="number"
              id="tolerance"
              min="0"
              max="1"
              step="0.1"
              value="0.3"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Area Threshold</label
            >
            <input
              type="number"
              id="areaThreshold"
              min="0"
              step="1"
              value="1"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Orthogonalize</label
            >
            <select
              id="orthogonalize"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            >
              <option value="false" selected>No</option>
              <option value="true">Yes</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Max Angle Change (°)</label
            >
            <input
              type="number"
              id="maxAngleChange"
              min="0"
              max="45"
              value="15"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Skew Tolerance (°)</label
            >
            <input
              type="number"
              id="skewTolerance"
              min="0"
              max="45"
              value="15"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Zoom Level</label
            >
            <input
              type="number"
              id="zoomLevel"
              min="15"
              max="20"
              value="19"
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"
            />
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Source Imagery</label
            >
            <input
              type="text"
              id="sourceImagery"
              placeholder="Will be auto-populated from project details"
              readonly
              class="w-full px-2 py-1 text-sm border border-gray-300 rounded bg-gray-50"
            />
          </div>
          <div class="col-span-2 flex justify-end space-x-2 mt-4">
            <button
              type="button"
              onclick="closePredictionModal()"
              class="px-4 py-2 text-gray-600 hover:text-gray-800"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600"
            >
              <span id="submitButtonText">Generate Predictions</span>
              <div
                id="submitSpinner"
                class="spinner hidden inline-block ml-2"
              ></div>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="statusModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 w-96 max-w-md mx-4">
        <h2 class="text-xl font-bold mb-4">Prediction Status</h2>
        <div class="mb-4">
          <div class="flex items-center">
            <div class="spinner mr-3"></div>
            <span id="statusText">Processing prediction...</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div
              id="progressBar"
              class="bg-blue-600 h-2 rounded-full transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>
        </div>
        <div class="flex justify-end">
          <button
            onclick="closeStatusModal()"
            class="px-4 py-2 text-gray-600 hover:text-gray-800"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <div class="flex h-full">
      <div class="w-96 bg-white shadow-lg overflow-y-auto">
        <div id="userInfo" class="p-4 bg-blue-50 border-b hidden">
          <div class="flex items-center">
            <img
              id="userAvatar"
              src=""
              alt="User"
              class="w-8 h-8 rounded-full mr-3"
            />
            <div>
              <div id="userName" class="font-medium text-sm"></div>
              <div id="userEmail" class="text-xs text-gray-600"></div>
            </div>
          </div>
        </div>

        <div id="projectDetails" class="p-4 hidden">
          <button
            onclick="backToProjectsList()"
            class="mb-4 text-blue-500 hover:text-blue-700 text-sm"
          >
            Back to Projects
          </button>
          <h2 id="projectName" class="text-xl font-bold mb-2"></h2>
          <div class="mb-4">
            <span
              id="projectStatus"
              class="px-2 py-1 rounded-full text-xs font-medium"
            ></span>
            <span
              id="projectPriority"
              class="px-2 py-1 rounded-full text-xs font-medium ml-2"
            ></span>
          </div>
          <p id="projectDescription" class="text-gray-700 mb-4"></p>

          <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-50 p-3 rounded">
              <div class="text-xs text-gray-600">Mapped</div>
              <div id="percentMapped" class="font-semibold"></div>
            </div>
            <div class="bg-gray-50 p-3 rounded">
              <div class="text-xs text-gray-600">Validated</div>
              <div id="percentValidated" class="font-semibold"></div>
            </div>
          </div>

          <div class="mb-4">
            <div class="text-sm font-medium mb-2">Imagery</div>
            <div id="imageryDetails" class="bg-gray-50 p-3 rounded">
              <div class="text-xs text-gray-600">Source</div>
              <div id="imagerySource" class="font-medium text-sm mb-2"></div>
              <div class="text-xs text-gray-600">License</div>
              <div id="imageryLicense" class="text-sm"></div>
            </div>
          </div>

          <div class="mb-4">
            <div class="text-sm font-medium mb-2">Tasks Status</div>
            <div id="taskStats" class="space-y-1"></div>
          </div>

          <div class="space-y-2">
            <button
              onclick="checkExistingPredictions()"
              class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
            >
              Check Existing Predictions
            </button>
            <button
              onclick="showPredictionModal()"
              class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors"
            >
              Generate AI Predictions
            </button>
          </div>

          <div id="predictionResults" class="mt-4 hidden">
            <h3 class="font-medium mb-2">Prediction Results</h3>
            <div id="predictionFiles" class="space-y-1"></div>
            <div id="predictionStats" class="mt-2 text-sm text-gray-600"></div>
          </div>
        </div>

        <div id="projectsList" class="p-4">
          <h2 class="text-xl font-bold mb-4">HOT Tasking Manager Projects</h2>
          <div id="loadingProjects" class="text-center py-8">
            <div class="spinner mx-auto mb-2"></div>
            <p class="text-gray-600">Loading projects...</p>
          </div>
          <div id="projectsContainer" class="space-y-2 hidden"></div>
        </div>
      </div>

      <div class="flex-1 relative">
        <div id="map" class="w-full h-full"></div>
      </div>
    </div>
    <script src="js/app.js"></script>
  </body>
</html>
